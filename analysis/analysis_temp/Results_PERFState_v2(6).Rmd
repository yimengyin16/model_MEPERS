---
title: "CalPERS State plan & policy options: \npreliminary results for discussion"
output:
  html_notebook:
    toc: yes
    number_sections: yes
  word_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---

```{r loading results, include=FALSE}

source(paste0(here::here(), "/libraries.R"))


dir_sims <- "model/simulation/outputs_sim2t/"

# sim names
{df_simNames <- 
  tribble(
  ~simName, ~label_benPolicy,
  "misc2t_baseline",                      "Baseline: Current policy",
    
  "misc2t_benCut1_lowERC",                "Reduce benefit factor \nfor future service by 50%",
  "misc2t_benCut1_highERC",               "Reduce benefit factor \nfor future service by 50%",
  
  "misc2t_colaCut1_lowERC",               "No COLA until 100% funded (7%DR)",
  "misc2t_colaCut1_highERC",              "No COLA until 100% funded (7%DR)",
  
  "misc2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  "misc2t_benCut1_colaCut1_highERC",      "Combine the two above",
  
  "misc2t_benCut2_lowERC",                "Reduce benefit factor \nfor future service by 25%",
  "misc2t_benCut2_highERC",               "Reduce benefit factor \nfor future service by 25%",
  
  "misc2t_colaCut2_lowERC",               "Half COLA until 100% funded (7%DR)",
  "misc2t_colaCut2_highERC",              "Half COLA until 100% funded (7%DR)",
  
  "misc2t_benCut2_colaCut2_lowERC",       "Combine the two above",
  "misc2t_benCut2_colaCut2_highERC",      "Combine the two above",
  
  "misc2t_colaCut2lowerDR_lowERC",        "Half COLA until 100% funded (5%DR)",
  "misc2t_colaCut2lowerDR_highERC",       "Half COLA until 100% funded (5%DR)",
  
  "misc2t_colaCut1lowerDR_lowERC",        "No COLA until 100% funded (5%DR)",
  "misc2t_colaCut1lowerDR_highERC",       "No COLA until 100% funded (5%DR)",
  
  
  "sfty2t_baseline",                      "Baseliine: Current policy",

  "sfty2t_benCut1_lowERC",                "Reduce benefit factor \nfor future service by 50%",
  "sfty2t_benCut1_highERC",               "Reduce benefit factor \nfor future service by 50%",

  "sfty2t_colaCut1_lowERC",               "No COLA until 100% funded (7%DR)",
  "sfty2t_colaCut1_highERC",              "No COLA until 100% funded (7%DR)",

  "sfty2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  "sfty2t_benCut1_colaCut1_highERC",      "Combine the two above",

  "sfty2t_benCut2_lowERC",                "Reduce benefit factor \nfor future service by 25%",
  "sfty2t_benCut2_highERC",               "Reduce benefit factor \nfor future service by 25%",

  "sfty2t_colaCut2_lowERC",               "Half COLA until 100% funded (7%DR)",
  "sfty2t_colaCut2_highERC",              "Half COLA until 100% funded (7%DR)",

  "sfty2t_benCut2_colaCut2_lowERC",       "Combine the two above",
  "sfty2t_benCut2_colaCut2_highERC",      "Combine the two above",

  "sfty2t_colaCut2lowerDR_lowERC",        "Half COLA until 100% funded (5%DR)",
  "sfty2t_colaCut2lowerDR_highERC",       "Half COLA until 100% funded (5%DR)",
  
  "sfty2t_colaCut1lowerDR_lowERC",        "No COLA until 100% funded (5%DR)",
  "sfty2t_colaCut1lowerDR_highERC",       "No COLA until 100% funded (5%DR)",
  
  "all2t_baseline",                      "Baseliine: Current policy",

  "all2t_benCut1_lowERC",                "Reduce benefit factor \nfor future service by 50%",
  "all2t_benCut1_highERC",               "Reduce benefit factor \nfor future service by 50%",

  "all2t_colaCut1_lowERC",               "No COLA until 100% funded (7%DR)",
  "all2t_colaCut1_highERC",              "No COLA until 100% funded (7%DR)",

  "all2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  "all2t_benCut1_colaCut1_highERC",      "Combine the two above",

  "all2t_benCut2_lowERC",                "Reduce benefit factor \nfor future service by 25%",
  "all2t_benCut2_highERC",               "Reduce benefit factor \nfor future service by 25%",

  "all2t_colaCut2_lowERC",               "Half COLA until 100% funded (7%DR)",
  "all2t_colaCut2_highERC",              "Half COLA until 100% funded (7%DR)",

  "all2t_benCut2_colaCut2_lowERC",       "Combine the two above",
  "all2t_benCut2_colaCut2_highERC",      "Combine the two above",

  "all2t_colaCut2lowerDR_lowERC",        "Half COLA until 100% funded (5%DR)",
  "all2t_colaCut2lowerDR_highERC",       "Half COLA until 100% funded (5%DR)",
  
  "all2t_colaCut1lowerDR_lowERC",        "No COLA until 100% funded (5%DR)",
  "all2t_colaCut1lowerDR_highERC",       "No COLA until 100% funded (5%DR)",
  
  
  "poff2t_baseline",                      "Baseliine: Current policy",

  "poff2t_benCut1_lowERC",                "Reduce benefit factor \nfor future service by 50%",
  "poff2t_benCut1_highERC",               "Reduce benefit factor \nfor future service by 50%",

  "poff2t_colaCut1_lowERC",               "No COLA until 100% funded (7%DR)",
  "poff2t_colaCut1_highERC",              "No COLA until 100% funded (7%DR)",

  "poff2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  "poff2t_benCut1_colaCut1_highERC",      "Combine the two above",

  "poff2t_benCut2_lowERC",                "Reduce benefit factor \nfor future service by 25%",
  "poff2t_benCut2_highERC",               "Reduce benefit factor \nfor future service by 25%",

  "poff2t_colaCut2_lowERC",               "Half COLA until 100% funded (7%DR)",
  "poff2t_colaCut2_highERC",              "Half COLA until 100% funded (7%DR)",

  "poff2t_benCut2_colaCut2_lowERC",       "Combine the two above",
  "poff2t_benCut2_colaCut2_highERC",      "Combine the two above"
  # 
  # "poff2t_colaCut2lowerDR_lowERC",        "Half COLA until 100% funded (5%DR)",
  # "poff2t_colaCut2lowerDR_highERC",       "Half COLA until 100% funded (5%DR)",
  # 
  # "poff2t_colaCut1lowerDR_lowERC",        "No COLA until 100% funded (5%DR)",
  # "poff2t_colaCut1lowerDR_highERC",       "No COLA until 100% funded (5%DR)"
)
}


#filter(df_simNames, !str_detect(simName, "all2t"))

# df_simNames$simName
df_results <- 
  map(filter(df_simNames, !str_detect(simName, "all2t"))$simName, ~ readRDS(paste0(here::here(), "/", dir_sims, "sim_", .x, ".rds"))$results) %>% 
  bind_rows() %>% 
  mutate(NC.ER_PR = 100*(NC - EEC)/PR ) 
  # mutate(
  #        #sim_name = str_replace(sim_name, "&", "_"),
  #        sim_name = factor(sim_name, levels = df_simNames$simName )
  #        )


vars_report <- c("sim_name","sim", "year", "AL", "UAAL", "FR_MA", "ERC", "ERC_PR", "NC_PR", "NC.ER_PR", "SC_PR")
vars_table  <- c("sim_name", "year", "AL", "FR_MA", "ERC", "ERC_PR")


## data frame for aggregate results for misc2t and sfty2t

vars_agg <- c("AL", "UAAL", "MA", "AA", "NC", "SC", "ERC", "EEC", "PR")

df_results_agg <- 
  df_results %>% 
  filter(!str_detect(sim_name, "poff2t")) %>% 
  mutate(policy_name = str_remove(sim_name, "misc2t_|sfty2t_")) %>% 
  group_by(policy_name, sim, year) %>% 
  summarise(
    AL = sum(AL),
    MA = sum(MA),
    AA = sum(AA),
    UAAL = sum(UAAL),
    NC = sum(NC),
    SC = sum(SC),
    ERC = sum(ERC),
    EEC = sum(EEC),
    PR  = sum(PR),
    B   = sum(B),
    i.r = i.r[1],
    .groups = "drop"
  ) %>% 
  mutate(sim_name = paste0("all2t_", policy_name),
         FR_MA  = 100 * MA/AL,
         ERC_PR = 100 * ERC/PR,
         EEC_PR = 100 * EEC/PR,
         NC_PR  = 100 * NC/PR,
         SC_PR  = 100 * SC/PR,
         NC.ER_PR = 100 * (NC - EEC)/PR,
         NC.ER    =  NC - EEC
         )

df_results <- 
  bind_rows(df_results,
            df_results_agg) %>% 
  mutate(
         #sim_name = str_replace(sim_name, "&", "_"),
         sim_name = factor(sim_name, levels = df_simNames$simName )
         ) %>% 
  arrange(sim_name, sim, year)

# df_results_agg %>% select(sim, year,  sim_name, policy_name) %>% 
#   filter(sim == 1, year ==2018) %>% 
#   group_by(policy_name) %>% 
#   arrange(policy_name)
# df_results$sim_name

df_results %>%
  filter(sim_name %in%  c("all2t_baseline", 
                          "all2t_benCut1_lowERC", 
                          "all2t_colaCut1_lowERC",
                          "all2t_benCut1_colaCut1_lowERC"), 
         year %in% c(2018), sim == 0) %>%
  select(sim_name, year, FR_MA,NC, NC.ER, SC, ERC, EEC_PR, UAAL, AL)

```


$~$


# **Updates**

## What's new 

Updates since the previous 

- Classic members and PEPRA members are modeled separately. 
- Add the 5-year ramp-up period to the amortization method
- Add analysis of the impact on member benefit (in progress)


Updates since the memo of June 28, 2020

- Added results for a new group consisting of state safety, peace officers and firefighters(POFF), and California Highway Patrol(CHP) members.
- Added 3 new policies that involve lesser reductions in the COLA and in the benefit factor for future service
- Added a contingent COLA policy in which COLA is determined based on funded ratio calculated using 5% discount rate.
- Minor modeling improvements that cause numbers to change slightly from the previous memo 


## Future updates
We're working on the following changes for the next update.

- Modeling classic members and PEPRA members separately
- Impacts on plan members
- Stochastic analysis
- Various minor policy features of PERF A (e.g. amortization with ramp-up period)


## Key conclusions {.tabset} 

```{r summary, include=FALSE}
# library(officer)

df_summary_det <- 
  df_results %>% 
  filter(sim == 0,
         year <= 2030) %>% 
  select(any_of(c("year", "sim_name", "UAAL", "ERC"))) %>% 
  filter(year %in% c(2018, 2028)) %>% 
  filter(!str_detect(sim_name, "colaCut1lowerDR")) %>% 
  mutate(UAAL = UAAL/1e9,
         ERC = ERC/1e9) %>% 
  gather(Var, value, -sim_name, -year) %>% 
  mutate(Var = paste0( "y", year, "_", Var ),
         year = NULL
         ) %>% 
  spread(Var, value) 
# df_summary_det

make_summaryTable <- function(df, grpName, grpName_label){
  
 # df <- df_summary_det
 # grpName <- "sftyAll"
 # grpName_label <-  "Group: State Safety, POFF, and CHP"
  
bind_rows(
  (df %>% 
    filter(str_detect(sim_name, grpName )) %>% 
    mutate(ERCpolicy = "")
   )[1,],

  (df %>% 
    filter(str_detect(sim_name, grpName)) %>% 
    mutate(across(!c(sim_name), ~ 100*(.x/.x[1] - 1))) %>% 
    mutate(ERCpolicy = str_extract(sim_name, "lowERC|highERC"))
    )[-1,]
  ) %>%
  as_tibble() %>% 
  mutate(ERCpolicy = factor(ERCpolicy, 
                            levels = c("", "lowERC", "highERC"),
                            labels = c("", "Low ERC", "High ERC")
                            
                            )) %>% 
  arrange(ERCpolicy) %>% 
  relocate(ERCpolicy) %>% 
  mutate(sim_name = factor(sim_name, 
                           levels = df_simNames$simName, 
                           labels = df_simNames$label_benPolicy)
         ) %>% 
  flextable() %>% 
  
  # Global settings
   hrule(rule = "exact", part = "all") %>%
  
  # Header
   add_header_row(values = c("", 
                            "2018",
                            "2028"),
                 colwidths = c(2,2,2)) %>%
  
   theme_booktabs() %>% 
   add_header_lines(values = "Amounts in $ billions for baseline (row 1); % change relative to baseline for other policies" ) %>%
   add_header_lines(values = "Assumes investment returns of 7% every year (based on CalPERS assumptions)" ) %>%
   add_header_lines(values = grpName_label) %>%  
   add_header_lines(values = "Estimated impacts of selected policy alternatives" ) %>%
   
   align(align = "center", part = "header")  %>%
   height(part = "header",   height = .5, i = 1) %>% 
   height(part = "header",   height = .5, i = 5:6) %>% 
   fontsize(size = 12, part = "header") %>%
   fontsize(size = 18, part = "header", i = 1) %>% 
   fontsize(size = 16, part = "header", i = 2) %>% 
   
   set_header_labels(values =
                      list(
                      ERCpolicy  = "",
										  sim_name   = "Policy scenario",
										  y2018_ERC  = "Employer\ncontribution",
										  y2028_ERC  = "Employer\ncontribution", 
										  y2018_UAAL = "UAAL",
										  y2028_UAAL = "UAAL"
										  )
										) %>% 
  
   # Body
   fontsize(size = 12, part = "body") %>% 
   width(j = 1,   width = 0.6)   %>%
   width(j = 2,   width = 3)   %>%
   width(j = 3:6, width = 1.2) %>%
   height(part = "body",   height = .5) %>%
  
   colformat_num(i = c(1), j = 3:6,    digits = 1, prefix = "$") %>% 
   colformat_num(i = c(2:15), j = 3:6, digits = 1, suffix = "%") %>% 
   
   hline(part = "body", i = c(1, 8), border = officer::fp_border(color="gray40", width = 1.5)) %>% 
   hline(part = "body", i = c(4, 11), border = officer::fp_border(color="gray40", style = "dotted")) %>%  
   # vline(part = "body", j = c(4), border = officer::fp_border(color="gray40", style = "dotted"))
   merge_v( j = "ERCpolicy") %>% 
   
  # Footer
  add_footer_lines(values = "Notes:") %>% 
  add_footer_lines(values = "Low ERC: Employer contributions are reduced to reflect lower actuarially determined contributions (ADC)") %>% 
  add_footer_lines(values = "High ERC: Employer contributions are approximately maintained despite drop in ADC") %>% 
  height(part = "footer",   height = .5) %>% 
  fontsize(size = 12, part = "footer") 
}  
      
#make_summaryTable(df_summary_det, "miscAll", "Group: State Misc and Industrial")
#make_summaryTable(df_summary_det, "sftyAll", "Group: State Safety, POFF, and CHP")



```



### All state members, 7% return 

```{r, echo=FALSE}
make_summaryTable(df_summary_det, "all2t", "Group: All state members")
```


### State Misc, 7% return 

```{r, echo=FALSE}
make_summaryTable(df_summary_det, "misc2t", "Group: State Misc and Industrial")
```

### State safety, 7% return 

```{r, echo = FALSE}
make_summaryTable(df_summary_det, "sfty2t", "Group: State Safety, POFF, and CHP")
```


$~$


# **Overview**

We present below early results of our analysis for CalPERS state members of PERF A. 


## Types of members
There are five types of state members in PERF A and currently we categorize and model them as two groups based on the similarity of benefit policies and member characteristics:

- **Group 1**: State miscellaneous and state industrial members. 
- **Group 2**: State safety members, state peace officers/firefighters (POFF), and California Highway Patrol (CHP)

(TODO: We are going to distinguish classic and PEPRA members in each group in the next iteration)

See appendix for a diagram that summarizes the types of state members of PERF A. 


## Policy scenarios
We have modeled each group under current policy and under three types of alternative policies, each with several variants differing in the degree that benefits are affected:

1. Benefit factor reduction: For all future years of service for all active employees, an x% reduction in the “benefit factor.” (The benefit factor is multiplied by a plan member’s final salary and years of service to determine the initial retirement benefit.) This is far more aggressive than the policies that have been tested in “California Rule” litigation, which have
focused on much narrower scaling back of future benefits (e.g., disallowing “air time”). Variants:
  
    - 50% reduction to benefit factor.
    - 25% reduction to benefit factor.
    - (Example: If the original benefit factor is 3%, it will become 2.25% after a 25% reduction )

2. COLA suspension: The COLA/escalator is suspended or reduced until the plan's funded ratio reaches a certain level. Variants:

    - COLA is fully suspended until the plan is fully funded under the plan chosen actuarial discount rate (7%).
    - COLA is reduced from 2% to 1% per year until the plan is fully funded under the plan chosen actuarial discount rate (7%).
    - COLA is reduced from 2% to 1% per year until the plan is fully funded under a more conservative discount rate (5%). (Similar to the Rhode Island plan) 
    

3. Both policies combined: The benefit factor is reduced and the COLA is
suspended/reduced. Variants:

    - 50% benefit factor reduction + full COLA suspension until full funding (7% discount rate)
    - 25% benefit factor reduction + COLA reduced to half (1%) until full funding (7% discount rate)  

We assume all policies go fully into effect in the first year. The benefit factor reduction affects future
service of current workers and all service of new hires. The COLA suspension affects all current retirees,
all current workers, and all new hires.


The policies with greater benefit reductions help define bounds, and the policies with lesser benefit reductions are closer to what might be practical for policymakers. 

Additional variants that we may explore in the future: (1) providing lesser reductions for older retirees or workers who are close to retirement, (2) apply only to new hires. These variants would provide lower fiscal savings and greater protection to plan
members.

## Assumptions on how CA governments would respond 
We examined these policies under two assumptions about how California governments would respond:

1. Assumption A: Take the savings now, in lower contributions: All policies reduce actuarial
liability, unfunded liability, and normal cost. Lower normal cost and amortization cost reduce
the actuarially determined contribution (ADC). Under this assumption employers pay just the ADC,
which would be lower than what they pay now.

2. Assumption B: Maintain employer contributions despite the ADC reduction: Even though the ADC is
lower, employers pay the ADC plus an additional contribution to keep their payments near
where they were before, reducing unfunded liability more quickly than otherwise. However, this
can interact with the contingent COLA: if full funding is reached sooner, then benefit payments
will go up as the COLA is put back into effect.


## Investment return scenarios
In the tables below we show results for 2018 (the actuarial valuation year and our first year) and for
2028. The model goes out much further in time and it can be useful to pay attention to later time
periods as well to gain a better understanding of investment risks and amortization policies.
We have examined these policies and variants under three investment scenarios:

1. Deterministic: 7% investment return assumption achieved every year. This is the CalPERS
assumption, save for any planned earnings assumption reductions.

2. Deterministic asset shock: This is based loosely on stress-test scenarios used by Pew, which in
turn are based loosely on Dodd-Frank assumptions. We assume 7% return in 2018, 2% in 2019,
negative 24% in 2020, then 3 years of 12% (2021-2023), then 7% annually thereafter.

3. Stochastic: 7% expected mean return, 12% standard deviation: This allows us to see how the
policies, particularly the contingent COLA policy, interact with investment return volatility.
The tables below provide summary results for the deterministic scenarios. We will add tables for the
stochastic return scenario in a later iteration.


# **Preliminary results**

```{r funSummaryDetail, echo=FALSE}
# library(officer)

# select group names:


make_summaryTable_detailed <- function(grpName, sim_select){

# sim_select <- 0
# grpName <- "misc2t"
grpName_label <- switch (grpName,
                         miscAll = "Group: State misc and industrial",
                         sftyAll = "Group: State safety, POFF, and CHP",
                         misc2t = "Group: State misc and industrial",
                         sfty2t = "Group: State safety, POFF, and CHP",
                         all2t  = "Group: All state members",
                         )

return_label <- switch (as.character(sim_select),
  "0"  = "Assumes investment returns of 7% every year (based on CalPERS assumptions)",
  "-2" = "Asset shock: 7% in 2018, 2% in 2019, minus 24% in 2020, then 3 years of 12% (2021-2023), then 7% annually"
)


 

 df <- 
  df_results %>% 
  filter(sim == sim_select,
        year %in% c(2018, 2028)) %>% 
  filter(!str_detect(sim_name, "colaCut1lowerDR")) %>% 
  mutate(AL   = AL/1e9,
         UAAL = UAAL/1e9,
         ERC  = ERC/1e9) %>% 
  select(year, sim_name, v1_AL = AL, v2_UAAL = UAAL, v3_ERC = ERC, v4_FR_MA = FR_MA, v5_ERC_PR = ERC_PR) %>% 

  gather(Var, value, -sim_name, -year) %>% 
  mutate(Var = paste0( "y", year, "_", Var ),
         year = NULL
         ) %>% 
  spread(Var, value) 
# df_summary_det

# make_summaryTable <- function(df, grpName, grpName_label){
  


    
bind_rows(
  (df %>% 
    filter(str_detect(sim_name, grpName)) %>% 
    mutate(ERCpolicy = "")
   )[1,],

  (df %>% 
    filter(str_detect(sim_name, grpName)) %>% 
    mutate(across(!contains(c("ERC_PR", "FR_MA", "sim_name")) , ~ 100*(.x/.x[1] - 1))) %>% 
    mutate(across(contains(c("ERC_PR", "FR_MA")) , ~ .x - .x[1])) %>% 
    mutate(ERCpolicy = str_extract(sim_name, "lowERC|highERC"))
    )[-1,]
  ) %>%
  as_tibble() %>% 
  mutate(ERCpolicy = factor(ERCpolicy, 
                            levels = c("", "lowERC", "highERC"),
                            labels = c("", "Low ERC", "High ERC")
                            
                            )) %>% 
  arrange(ERCpolicy) %>% 
  relocate(ERCpolicy) %>% 
  mutate(sim_name = factor(sim_name, 
                           levels = df_simNames$simName, 
                           labels = df_simNames$label_benPolicy)
         ) %>% 
  flextable() %>% 
  
  # Global settings
   hrule(rule = "exact", part = "all") %>%
  
  # Header
   add_header_row(values = c("", 
                            "2018",
                            "2028"),
                 colwidths = c(2,5,5)) %>%
  
   theme_booktabs() %>% 
   # add_header_lines(values = "(Amounts in $ billions)" ) %>%
   add_header_lines(values = return_label) %>%
   add_header_lines(values = grpName_label) %>%  
   add_header_lines(values = "Estimated impacts of selected policy alternatives" ) %>%
   
   align(align = "center", part = "header")  %>%
   height(part = "header",   height = .5, i = 1) %>% 
   height(part = "header",   height = .5, i = 4:5) %>% 
   fontsize(size = 12, part = "header") %>%
   fontsize(size = 18, part = "header", i = 1) %>% 
   fontsize(size = 16, part = "header", i = 2) %>% 
   fontsize(size = 14, part = "header", i = 3) %>% 
   set_header_labels(values =
                      list(
                      ERCpolicy  = "",
										  sim_name   = "policy scenario",
										  
										  y2018_v1_AL  = "Actuarial\nLiability",
										  y2028_v1_AL  = "Actuarial\nLiability",
										  
										  y2018_v2_UAAL  = "UAAL",
										  y2028_v2_UAAL  = "UAAL",
										  
										  y2018_v3_ERC  = "Employer\ncontribution\n(ERC)",
										  y2028_v3_ERC  = "Employer\ncontribution\n(ERC)", 
										  
										  y2018_v4_FR_MA  = "Funded ratio\n(MVA basis)",
										  y2028_v4_FR_MA  = "Funded ratio\n(MVA basis)", 
										  
										  y2018_v5_ERC_PR  = "ERC as\n% of payroll",
										  y2028_v5_ERC_PR  = "ERC as\n% of payroll"
										  )
										) %>% 
  
   # Body
   fontsize(size = 12, part = "body") %>% 
   width(j = 1,   width = 0.6)   %>%
   width(j = 2,   width = 3.5)   %>%
   width(j = 3:12, width = 1.1) %>%
   height(part = "body",   height = .5) %>%
  
   colformat_num(i = c(1), j = c(3:5, 8:10),    digits = 1, prefix = "$") %>%
   colformat_num(i = c(1), j = c(6:7, 11:12),    digits = 1, suffix = "%") %>%
   colformat_num(i = c(2:15), j = 3:12, digits = 1, suffix = "%") %>% 
   
   hline(part = "body", i = c(1, 8), border = officer::fp_border(color="gray40", width = 1.5)) %>% 
   hline(part = "body", i = c(4, 11), border = officer::fp_border(color="gray40", style = "dotted")) %>%  
   vline(part = "all", j = c(7), border = officer::fp_border(color="gray40", style = "dotted")) %>% 
   merge_v( j = "ERCpolicy") %>% 
   
  # Footer
  add_footer_lines(values = "Notes:") %>% 
  add_footer_lines(values = "Low ERC: Employer contributions are reduced to reflect lower actuarially determined contributions (ADC)") %>% 
  add_footer_lines(values = "High ERC: Employer contributions are approximately maintained despite drop in ADC") %>% 
  add_footer_lines(values = "Baseline: Liability, UAAL and ERC in $billions") %>% 
  add_footer_lines(values = "Alternative policies: Values are changes relative to baseline. Liability, UAAL and ERC are % changes; funded ratio and ERC rate are absolute changes (alternative minus baseline)") %>% 
  height(part = "footer",   height = .5) %>% 
  fontsize(size = 12, part = "footer") 
}  
      
#make_summaryTable(df_summary_det, "miscAll", "Group: State Misc and Industrial")
#make_summaryTable(df_summary_det, "sftyAll", "Group: State Safety, POFF, and CHP")

```


## Deterministic results, with 7% annual returns {.tabset}


### All state members
```{r echo=FALSE}
make_summaryTable_detailed("all2t", 0)
```

### State misc
```{r echo=FALSE}
make_summaryTable_detailed("misc2t", 0)
```

### State safety 
```{r echo=FALSE}
make_summaryTable_detailed("sfty2t", 0)
```




## Asset shock scenario (24% decline in portfolio) {.tabset}

### all state members
```{r echo=FALSE}
make_summaryTable_detailed("all2t", -2)
```

### State misc
```{r echo=FALSE}
make_summaryTable_detailed("misc2t", -2)
```

### State safety 
```{r echo=FALSE}
make_summaryTable_detailed("sfty2t", -2)
```


```{r, eval = FALSE, include=FALSE}

file.copy(paste0(here::here(),"/analysis/Results_PERFState_v2.nb.html"), paste0(here::here(), "/docs/Results_PERFState_v2.nb.html"), overwrite = TRUE)

```


$~$

## Impact on member benefit

Cohorts to examine

- retirees at age 55 in 2018: misc classic, assuming receiving benefits up to age 85
- retirees at age 65 in 2018: misc classic, assuming receiving benefits up to age 85

- late-career active member: classic member at age 50 w/ entry age 25 in 2018, assuming retirement age of 55 
- mid-career  active member: classic member at age 40 w/ entry age 25 in 2018, assuming retirement age of 55


What to compare
- Plotting annual benefit: age 55 to 85
- PV benefit over age 55 to 85, dr = 0.7, valuated at age 55

scenario:

- assumption met
- asset shock 



```{r eval=FALSE, include=FALSE}


dir_outputs_val <- "model/valuation2/outputs_val/"
dir_outputs_sim <- "model/simulation/outputs_sim2t/"


get_impactMembers2 <- function(simName,
                               valName_baseline,
                               fn_ea  = 25,
                               fn_age1 = 45,
                               fn_age2 = 55,
                               fn_age3 = 65,
                               fn_ageRet = 55,
                               dr = 0.07){
# 
# simName <- "misc2t_benCut1_lowERC"
# valName_baseline <-  "misc2t_bf100_cola2"
# 
# fn_ea  = 25
# fn_age1 = 40
# fn_age2 = 50
# fn_age3 = 65
# fn_ageRet = 55
# dr = 0.07


ls_sim <- readRDS(paste0(dir_outputs_sim, paste0("sim_", simName,   ".rds")))
valName <- ls_sim$sim_paramlist$val_name

df_val_baseline <- readRDS(paste0(dir_outputs_val, paste0("val_", valName_baseline, ".rds")))
df_val_reduced  <- readRDS(paste0(dir_outputs_val, paste0("val_", valName,".rds")))


df_cola <- 
ls_sim$results %>% 
  filter(sim %in% c(0, -2)) %>% 
  select(sim_name, sim, year, cola_actual) %>%
  mutate(sim = ifelse(sim == 0, "cola_a", "cola_s")) %>% 
  spread(sim, cola_actual)

tier_select <- paste0(str_extract(simName, "sfty|misc"), "_classic")

df_B <- 
left_join(
  df_val_baseline$indivLiab[[tier_select]]$servRet.la %>% 
    filter( (start_year == 2018 - (fn_age1 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            #(start_year == 2018 - (fn_age2 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
             (year_servRet == 2018 & age_servRet == fn_age2)| # retiree
             (year_servRet == 2018 & age_servRet == fn_age3) # retiree
           ) %>% 
     select(age_servRet, start_year, ea, age, year, B_baseline = B.servRet.la),
  
  df_val_reduced$indivLiab[[tier_select]]$servRet.la %>% 
    filter( (start_year == 2018 - (fn_age1 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            #(start_year == 2018 - (fn_age2 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            (year_servRet == 2018 & age_servRet == fn_age2)| # retiree
            (year_servRet == 2018 & age_servRet == fn_age3) # retiree
           ) %>% 
    select(age_servRet, start_year, ea, age, year, B_reduced = B.servRet.la) 
) %>% 
# mutate(B_pctChg = B_reduced / B_baseline - 1) %>% 
arrange(start_year) %>% 
left_join(df_cola, by = "year")


df_B %<>% split(df_B$start_year)

for(i in names(df_B)){
  #i <- "2003" 
  
  df_B[[i]] %<>% 
    mutate(B_a = ifelse(year == min(year), B_reduced, 0),
           B_s = ifelse(year == min(year), B_reduced, 0))
  
  for(j in df_B[[i]]$year[-1]){
  #j = 2034
      df_B[[i]]$B_a[df_B[[i]]$year == j] <- df_B[[i]]$B_a[df_B[[i]]$year == j - 1] * (1 + df_B[[i]]$cola_a[df_B[[i]]$year == j - 1])
      df_B[[i]]$B_s[df_B[[i]]$year == j] <- df_B[[i]]$B_s[df_B[[i]]$year == j - 1] * (1 + df_B[[i]]$cola_s[df_B[[i]]$year == j - 1])
  }  
} 
  
df_B %<>% bind_rows() %>% 
  mutate(B_a_pctChg = B_a / B_baseline - 1,
         B_s_pctChg = B_s / B_baseline - 1) %>%
  mutate(age_2018 = ea + 2018 - start_year) %>% 
  relocate(sim_name, age_2018) 
 


df_pvB <- 
  df_B %>% 
  filter(age <= 85) %>% 
  group_by(age_2018) %>% 
  summarise(pvB_baseline    = sum(B_baseline    / (1 + dr)^(age - min(age))),
            pvB_a = sum(B_a / (1 + dr)^(age - min(age))),
            pvB_s = sum(B_s / (1 + dr)^(age - min(age)))
            ) %>% 
  mutate(pvB_a_pctChg = pvB_a / pvB_baseline - 1,
         pvB_s_pctChg = pvB_s / pvB_baseline - 1,
         sim_name = simName,
         age_2018 = paste0("age", age_2018)
         ) %>% 
  relocate(sim_name)
# df_pvB

# inversing the table

df_pvB2 <- 
  df_pvB %>% 
  select(sim_name, age_2018, pvB_a_pctChg, pvB_s_pctChg) %>% 
  gather(Var, value, -sim_name, -age_2018) %>% 
  spread(age_2018, value)
  

df <- list(df_B = df_B,
           df_pvB = df_pvB，
           df_pvB2 = df_pvB2)
}

ls_benCut1          <- get_impactMembers2(simName = "sfty2t_benCut1_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_colaCut1         <- get_impactMembers2(simName = "sfty2t_colaCut1_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_benCut1_colaCut1 <- get_impactMembers2(simName = "sfty2t_benCut1_colaCut1_lowERC", valName_baseline  = "sfty2t_bf100_cola2")


ls_benCut2          <- get_impactMembers2(simName = "sfty2t_benCut2_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_colaCut2         <- get_impactMembers2(simName = "sfty2t_colaCut2_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_benCut2_colaCut2 <- get_impactMembers2(simName = "sfty2t_benCut2_colaCut2_lowERC", valName_baseline  = "sfty2t_bf100_cola2")



ls_benCut1$df_pvB2    %>% kable()
ls_colaCut1$df_pvB2   %>% kable()
ls_benCut1_colaCut1$df_pvB2 %>% kable()





{df_simNames2 <- 
  tribble(
  ~simName, ~label_benPolicy,
  "sfty2t_baseline",                      "Baseline: Current policy",
    
  "sfty2t_benCut1_lowERC",                "Reduce benefit factor by 50%",
  "sfty2t_colaCut1_lowERC",               "No COLA below 100% funded (7% DR)",
  "sfty2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  
  "sfty2t_benCut2_lowERC",                "Reduce benefit factor by 25%",
  "sfty2t_colaCut2_lowERC",               "Half COLA below 100% funded (7% DR)",
  "sfty2t_benCut2_colaCut2_lowERC",       "Combine the two above"
  # 
  # "sfty2t_benCut1_highERC",               "Reduce benefit factor by 50%",
  # 
  # 
  # "sfty2t_colaCut1_highERC",              "No COLA below 100% funded (7% DR)",
  # 
  # 
  # "sfty2t_benCut1_colaCut1_highERC",      "Reduce benefit factor by 50% and \nNo COLA below 100% funded (7% DR)",
  # 
  # 
  # "sfty2t_benCut2_highERC",               "Reduce benefit factor by 25%",
  # 
  # 
  # "sfty2t_colaCut2_highERC",              "Half COLA below 100% funded (7% DR)",
  # 
  # 
  # "sfty2t_benCut2_colaCut2_highERC",      "Reduce benefit factor by 25% and \nHalf COLA below 100% funded (7% DR)",
  # 
  # "sfty2t_colaCut2lowerDR_lowERC",        "Half COLA below 100% funded (5% DR)",
  # "sfty2t_colaCut2lowerDR_highERC",       "Half COLA below 100% funded (5% DR)"
  )
}


df_tbl_misc_a <-  
  bind_rows(
    ls_benCut1$df_pvB2,
    ls_colaCut1$df_pvB2,
    ls_benCut1_colaCut1$df_pvB2,
    
    ls_benCut2$df_pvB2,
    ls_colaCut2$df_pvB2,
    ls_benCut2_colaCut2$df_pvB2
    
  ) %>% 
  left_join(df_simNames2, by=c("sim_name" = "simName") ) %>% 
  select(policy = label_benPolicy, everything(), -sim_name)  
  #mutate(policy = factor(policy, levels = df_simNames2))


df_tbl_misc_a %>% 
 filter(str_detect(Var, "pvB_a")) %>% 
 mutate(across(c(-policy, -Var), ~.x*100 )) %>% 
 select(-Var) %>% 
 flextable() %>% 
  
  # Global settings
   hrule(rule = "exact", part = "all") %>%
  
  # Header
   add_header_row(values = c("", 
                            "Reduction in present value of future benefits\nafter policy is implemented"),
                 colwidths = c(1,3)) %>%
  
   theme_booktabs() %>% 
   add_header_lines(values = "% changes are relative to baseline (current policy)") %>%
   add_header_lines(values = "Assumes investment returns of 7% every year (based on CalPERS assumptions)" ) %>%
   # add_header_lines(values = grpName_label) %>%  
   add_header_lines(values = "Estimated impacts on illustrative state peace officers\nof selected policy alternatives" ) %>%
   
   align(align = "center", part = "header")  %>%
   height(part = "header",   height = .55, i = 1) %>% 
   height(part = "header",   height = .3, i = 2:3) %>%
   height(part = "header",   height = .6, i = 4:5) %>% 
   fontsize(size = 12, part = "header") %>%
   fontsize(size = 18, part = "header", i = 1) %>%
   
   set_header_labels(values =
                      list(
										  policy = "Policy scenario",
										  age45 = "Active member\naged 45 in 2018",
										  age55 = "Retiree\naged 55 in 2018", 
										  age65 = "Retiree\naged 65 in 2018"
										  )
										) %>% 
  
   # Body
   fontsize(size = 12, part = "body") %>% 
   width(j = 1,   width = 3.2)   %>%
   width(j = 2:4, width = 1.5)   %>%
   height(part = "body",   height = .6) %>%
  
   #colformat_num(i = c(1), j = 3:6,    digits = 1, prefix = "$") %>% 
   colformat_num(j = 2:4, digits = 1, suffix = "%") %>% 
   
   #hline(part = "body", i = c(1, 8),  border = officer::fp_border(color="gray40", width = 1.5)) %>% 
   hline(part = "body", i = c(3), border = officer::fp_border(color="gray40", style = "dotted")) %>%  
   # vline(part = "body", j = c(4), border = officer::fp_border(color="gray40", style = "dotted"))
   #merge_v( j = "ERCpolicy") %>% 
   
  # Footer
  add_footer_lines(values = "Notes:") %>% 
  add_footer_lines(values = "- The illustrative plan members in the table are assumed to retirement at age 55 and live up to age 85.") %>% 
  #add_footer_lines(values = "- Discount rate in the calcuation of present value: 7%") %>% 
  add_footer_lines(values = "- Discount rate in the calcuation of present value: 7%") %>% 
  height(part = "footer",   height = .5) %>% 
  fontsize(size = 12, part = "footer") 

# 
# simName <- "misc2t_colaCut1_lowERC"
# ls_sim <- readRDS(paste0(dir_outputs_sim, paste0("sim_", simName,   ".rds")))
# ls_sim$results %>%
#   filter(sim %in% c(0)) %>%
#   select(sim_name, sim, year, cola_actual, FR_MA) %>%
#   mutate(sim = ifelse(sim == 0, "cola_a", "cola_s"))
# 
# 
# simName <- "misc2t_colaCut1lowerDR_lowERC"
# ls_sim <- readRDS(paste0(dir_outputs_sim, paste0("sim_", simName,   ".rds")))
# ls_sim$results %>%
#   filter(sim %in% c(0)) %>%
#   select(sim_name, sim, year, cola_actual, FR_MA) %>%
#   mutate(sim = ifelse(sim == 0, "cola_a", "cola_s"))



```


```{r}
# Impact on employer contributions, all state members for draft report to Crane

 df <- df_summary_det
 grpName <- "all2t"
 grpName_label <-  "Group: all state members"
  
 
{df_simNames3 <- 
  tribble(
  ~simName, ~label_benPolicy,
  "all2t_baseline",                      "Baseline: Current policy ($billion)",
  
  
  "all2t_benCut1_lowERC",                "Reduce benefit factor\n for future service by 50%",
  "all2t_colaCut1_lowERC",               "No COLA below 100% funded (7% DR)",
  "all2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  
  "all2t_benCut2_lowERC",                "Reduce benefit factor\n for future service  by 25%",
  "all2t_colaCut2_lowERC",               "Half COLA below 100% funded (7% DR)",
  "all2t_benCut2_colaCut2_lowERC",       "Combine the two above"
  
  # "all2t_benCut2_highERC",               "Reduce benefit factor by 25%",
  # "all2t_benCut1_highERC",               "Reduce benefit factor by 50%",  
  # 
  # "all2t_colaCut2_highERC",              "Half COLA below 100% funded (7% DR)",
  # "all2t_colaCut1_highERC",              "No COLA below 100% funded (7% DR)",
  # 
  # "all2t_benCut1_colaCut1_highERC",      "Reduce benefit factor by 50% and \nNo COLA below 100% funded (7% DR)",
  # "all2t_benCut2_colaCut2_highERC",      "Reduce benefit factor by 25% and \nHalf COLA below 100% funded (7% DR)",
  # 
  # "all2t_colaCut2lowerDR_lowERC",        "Half COLA below 100% funded (5% DR)",
  # "all2t_colaCut2lowerDR_highERC",       "Half COLA below 100% funded (5% DR)"
  )
}

 
df_tbl_impactPlan <-  
bind_rows(
  (df %>% 
    filter(str_detect(sim_name, grpName )) %>% 
    mutate(ERCpolicy = "")
   )[1,],

  (df %>% 
    filter(str_detect(sim_name, grpName)) %>% 
    mutate(across(!c(sim_name), ~ 100*(.x/.x[1] - 1))) %>% 
    mutate(ERCpolicy = str_extract(sim_name, "lowERC|highERC"))
    )[-1,]
  ) %>%
  as_tibble() 
  # mutate(ERCpolicy = factor(ERCpolicy, 
  #                           levels = c("", "lowERC", "highERC"),
  #                           labels = c("", "Low ERC", "High ERC")
  #                           
  #                           )) %>% 
  # arrange(ERCpolicy) %>% 
  # relocate(ERCpolicy) 
  # %>% 
  # mutate(sim_name = factor(sim_name, 
  #                          levels = df_simNames$simName, 
  #                          labels = df_simNames$label_benPolicy)
  #        )

df_tbl_impactPlan %<>% 
  filter(!str_detect(sim_name, "lowerDR")) %>% 
  #left_join(df_simNames3, by = c("sim_name" = "simName")) %>% 
  mutate(sim_name = factor(sim_name, 
                           levels = df_simNames3$simName,
                           labels = df_simNames3$label_benPolicy)) %>% 
  filter(ERCpolicy != "highERC") %>% 
  select(ERCpolicy, sim_name, everything(), -ERCpolicy)# %>% 
 
  # arrange(sim_name)
 

df_tbl_impactPlan %>% 
   flextable() %>% 
  
  # Global settings
   hrule(rule = "exact", part = "all") %>%
  
  # Header
   add_header_row(values = c("", 
                            "2018",
                            "2028"),
                 colwidths = c(1,2,2)) %>%
  
   theme_booktabs() %>% 
   add_header_lines(values = "% changes are relative to baseline (current policy)" ) %>%
   add_header_lines(values = "Assumes investment returns of 7% every year (based on CalPERS assumptions)" ) %>%
   add_header_lines(values = grpName_label) %>%  
   add_header_lines(values = "Estimated impacts on employer contributions\nof selected policy alternatives" ) %>%
   
   align(align = "center", part = "header")  %>%
   height(part = "header",   height = .5, i = 1) %>% 
   height(part = "header",   height = .3, i = 2) %>% 
   height(part = "header",   height = .25, i = 3:4) %>% 
   height(part = "header",   height = .5, i = 5:6) %>% 
   fontsize(size = 12, part = "header") %>%
   fontsize(size = 18, part = "header", i = 1) %>% 
   fontsize(size = 16, part = "header", i = 2) %>% 
   
   set_header_labels(values =
                      list(
                      #ERCpolicy  = "",
										  sim_name   = "Policy scenario",
										  y2018_ERC  = "Employer\ncontribution",
										  y2028_ERC  = "Employer\ncontribution", 
										  y2018_UAAL = "UAAL",
										  y2028_UAAL = "UAAL"
										  )
										) %>% 
  
   # Body
   fontsize(size = 12, part = "body") %>% 
   #width(j = 1,   width = 0.6)   %>%
   width(j = 1,   width = 3.2)   %>%
   width(j = 2:5, width = 1.2) %>%
   height(part = "body",   height = .6) %>%
  
   colformat_num(i = c(1), j = 2:5,    digits = 1, prefix = "$") %>% 
   colformat_num(i = c(2:7), j = 2:5, digits = 1, suffix = "%") %>% 
   
   hline(part = "body", i = c(1), border = officer::fp_border(color="gray40", width = 1.5)) %>% 
   hline(part = "body", i = c(4), border = officer::fp_border(color="gray40", style = "dotted")) %>%  
   # vline(part = "body", j = c(4), border = officer::fp_border(color="gray40", style = "dotted"))
   # merge_v( j = "ERCpolicy") %>% 
   
  # Footer
  add_footer_lines(values = "Notes:") %>% 
  add_footer_lines(values = "Employer contributions are reduced to reflect lower actuarially determined contributions (ADC)") %>% 
  # add_footer_lines(values = "High ERC: Employer contributions are approximately maintained despite drop in ADC") %>% 
  height(part = "footer",   height = .5) %>% 
  fontsize(size = 12, part = "footer") 

```





```{r}
# Impact on employer contributions, POFF members for draft report to Crane

 df <- df_summary_det
 grpName <- "poff2t"
 grpName_label <-  "Group: State Peace Officers and Firefighters"
  
 
{df_simNames_poff <- 
  tribble(
  ~simName, ~label_benPolicy,
  "poff2t_baseline",                      "Baseline: Current policy ($billion)",
  
  
  "poff2t_benCut1_lowERC",                "Reduce benefit factor\n for future service by 50%",
  "poff2t_colaCut1_lowERC",               "No COLA below 100% funded (7% DR)",
  "poff2t_benCut1_colaCut1_lowERC",       "Combine the two above",
  
  "poff2t_benCut2_lowERC",                "Reduce benefit factor\n for future service  by 25%",
  "poff2t_colaCut2_lowERC",               "Half COLA below 100% funded (7% DR)",
  "poff2t_benCut2_colaCut2_lowERC",       "Combine the two above"
  
  # "poff2t_benCut2_highERC",               "Reduce benefit factor by 25%",
  # "poff2t_benCut1_highERC",               "Reduce benefit factor by 50%",  
  # 
  # "poff2t_colaCut2_highERC",              "Half COLA below 100% funded (7% DR)",
  # "poff2t_colaCut1_highERC",              "No COLA below 100% funded (7% DR)",
  # 
  # "poff2t_benCut1_colaCut1_highERC",      "Reduce benefit factor by 50% and \nNo COLA below 100% funded (7% DR)",
  # "poff2t_benCut2_colaCut2_highERC",      "Reduce benefit factor by 25% and \nHalf COLA below 100% funded (7% DR)",
  # 
  # "poff2t_colaCut2lowerDR_lowERC",        "Half COLA below 100% funded (5% DR)",
  # "poff2t_colaCut2lowerDR_highERC",       "Half COLA below 100% funded (5% DR)"
  )
}

 
 
 
df_tbl_impactPlan <-  
bind_rows(
  (df %>% 
    filter(str_detect(sim_name, grpName )) %>% 
    mutate(ERCpolicy = "")
   )[1,],

  (df %>% 
    filter(str_detect(sim_name, grpName)) %>% 
    mutate(across(!c(sim_name), ~ 100*(.x/.x[1] - 1))) %>% 
    mutate(ERCpolicy = str_extract(sim_name, "lowERC|highERC"))
    )[-1,]
  ) %>%
  as_tibble() 
  # mutate(ERCpolicy = factor(ERCpolicy, 
  #                           levels = c("", "lowERC", "highERC"),
  #                           labels = c("", "Low ERC", "High ERC")
  #                           
  #                           )) %>% 
  # arrange(ERCpolicy) %>% 
  # relocate(ERCpolicy) 
  # %>% 
  # mutate(sim_name = factor(sim_name, 
  #                          levels = df_simNames$simName, 
  #                          labels = df_simNames$label_benPolicy)
  #        )

df_tbl_impactPlan %<>% 
  filter(!str_detect(sim_name, "lowerDR")) %>% 
  #left_join(df_simNames3, by = c("sim_name" = "simName")) %>% 
  mutate(sim_name = factor(sim_name, 
                           levels = df_simNames_poff$simName,
                           labels = df_simNames_poff$label_benPolicy)) %>% 
  filter(ERCpolicy != "highERC") %>% 
  select(ERCpolicy, sim_name, everything(), -ERCpolicy)# %>% 
 
  # arrange(sim_name)
 

df_tbl_impactPlan %>% 
   flextable() %>% 
  
  # Global settings
   hrule(rule = "exact", part = "all") %>%
  
  # Header
   add_header_row(values = c("", 
                            "2018",
                            "2028"),
                 colwidths = c(1,2,2)) %>%
  
   theme_booktabs() %>% 
   add_header_lines(values = "% changes are relative to baseline (current policy)" ) %>%
   add_header_lines(values = "Assumes investment returns of 7% every year (based on CalPERS assumptions)" ) %>%
   add_header_lines(values = grpName_label) %>%  
   add_header_lines(values = "Estimated impacts on employer contributions\nof selected policy alternatives" ) %>%
   
   align(align = "center", part = "header")  %>%
   height(part = "header",   height = .5, i = 1) %>% 
   height(part = "header",   height = .3, i = 2) %>% 
   height(part = "header",   height = .25, i = 3:4) %>% 
   height(part = "header",   height = .5, i = 5:6) %>% 
   fontsize(size = 12, part = "header") %>%
   fontsize(size = 18, part = "header", i = 1) %>% 
   fontsize(size = 16, part = "header", i = 2) %>% 
   
   set_header_labels(values =
                      list(
                      #ERCpolicy  = "",
										  sim_name   = "Policy scenario",
										  y2018_ERC  = "Employer\ncontribution",
										  y2028_ERC  = "Employer\ncontribution", 
										  y2018_UAAL = "UAAL",
										  y2028_UAAL = "UAAL"
										  )
										) %>% 
  
   # Body
   fontsize(size = 12, part = "body") %>% 
   #width(j = 1,   width = 0.6)   %>%
   width(j = 1,   width = 3.2)   %>%
   width(j = 2:5, width = 1.2) %>%
   height(part = "body",   height = .6) %>%
  
   colformat_num(i = c(1), j = 2:5,    digits = 1, prefix = "$") %>% 
   colformat_num(i = c(2:7), j = 2:5, digits = 1, suffix = "%") %>% 
   
   hline(part = "body", i = c(1), border = officer::fp_border(color="gray40", width = 1.5)) %>% 
   hline(part = "body", i = c(4), border = officer::fp_border(color="gray40", style = "dotted")) %>%  
   # vline(part = "body", j = c(4), border = officer::fp_border(color="gray40", style = "dotted"))
   # merge_v( j = "ERCpolicy") %>% 
   
  # Footer
  add_footer_lines(values = "Notes:") %>% 
  add_footer_lines(values = "Employer contributions are reduced to reflect lower actuarially determined contributions (ADC)") %>% 
  # add_footer_lines(values = "High ERC: Employer contributions are approximately maintained despite drop in ADC") %>% 
  height(part = "footer",   height = .5) %>% 
  fontsize(size = 12, part = "footer") 

```







$~$


# **Appendix**

![](C:/Git/Proj_CAPlans/model_CalPERS/analysis/PlanInfo.png)


```{r sftyAll_det_lowERC, eval=FALSE, include=FALSE}
#library(officer)

df_sftyAll_det_lowERC <- 
  df_results %>% 
  filter(sim == 0,
         year <= 2030,
         str_detect(sim_name, "sftyAll"),
         str_detect(sim_name, "baseline|lowERC")
         )


tab_sftyAll_det_lowERC <- 
df_sftyAll_det_lowERC %>% 
  select(any_of(vars_table)) %>% 
  filter(year %in% c(2018, 2028)) %>% 
  mutate(AL = AL/1e9,
         ERC = ERC/1e9) %>% 
  gather(Var, value, -sim_name, -year) %>% 
  mutate(Var = factor(Var, levels = c("AL", "ERC", "FR_MA",  "ERC_PR"),
                           labels = c("Actuarial liability", 
                                      "Employer contribution(ERC)",
                                      "Funded ratio, \nMV basis",
                                      "ERC as % of payroll")      
                      
                      )) %>% 
  spread(sim_name, value) %>% 
  arrange(year) %>% 
  flextable() %>% 
  add_header_row(values = c("", 
                            "Policies with greater \nbenefit/COLA reduction", 
                            "Policies with lesser \nbenefit/COLA reduction"), 
                 colwidths = c(3,3,3 )) %>% 
  theme_booktabs() %>% 
  add_header_row(values = "Assumes investment returns of 7% every year (based on CalPERS assumptions) \nAssumption A: Reduce employer contribution to reflect new lower actuarially determined contribution", 
								 colwidths = 9) %>% 
  add_header_row(values = "Group: State safety, POFF, and CHP", 
								 colwidths = 9) %>%
  
  add_header_row(values = "Estimated impacts of selected policy alternatives on CalPERS PERF A, simplified assumptions", 
								 colwidths = 9) %>% 
  add_footer_row(values = "Amounts are in $ billions", 
								 colwidths = 9) %>% 
 
  height(part = "body",   height = .6) %>%
	height(part = "header", i = 1:2, height = .4) %>%
	height(part = "header", i = 3, height   = .6) %>%
  height(part = "header", i = 4, height = .9) %>%
  height(part = "header", i = 5, height = .9) %>%
  hrule(rule = "exact", part = "all") %>%
  width(j = 1, width = 0.6) %>%
  width(j = 2, width = 0.4) %>%
	width(j = 3:9, width = 1.6) %>%
  fontsize(size = 18, part = "header", i = 1:2) %>% 
  fontsize(size = 15, part = "header", i = 3) %>% 
  fontsize(size = 14, part = "header", i = 4:5) %>% 
  fontsize(size = 14, part = "footer", i = 1) %>% 
  fontsize(size = 14, part = "body", j = 1:9) %>% 
	# autofit(add_w = 1) %>% 
	align(j = 1, align = "center", part = "all")  %>%
  #align(j = 2, align = "center", part = "body")  %>%
  align(i = 4, align = "center", part = "header")  %>%
  align(i = 5, align = "right", part = "header")  %>%
  align(i = 1, align = "left", part = "footer")  %>%
  merge_v( j = "year") %>% 
  colformat_num(i = c(1,2,5,6), j = 3:9, digits = 1, prefix = "$") %>% 
  colformat_num(i = c(3,4,7,8), j = 3:9, digits = 1, suffix = "%") %>% 
  set_header_labels(values =
                      list(
                      year = "Year",
										  Var  = "Variable",
										  sftyAll_baseline        = "Baseline \ncurrent policy",
                      sftyAll_benCut1_lowERC  = "Reduce \nbenefit factor \nby 50%",
										  sftyAll_colaCut1_lowERC = "No COLA until 100% funded (7% discount)",
                      sftyAll_benCut1_colaCut1_lowERC = "Both policies(left) \ncombined",
                      sftyAll_benCut2_lowERC  = "Reduce \nbenefit factor \nby 25%",
										  sftyAll_colaCut2_lowERC = "Half COLA until 100% funded (7% discount)",
										  sftyAll_benCut2_colaCut2_lowERC = "Both policies(left) \ncombined"
										  )
  ) %>% 
  hline(part = "body", i = 4, border = officer::fp_border(color="gray40") ) %>% 
  #hline_bottom(part = "body", border = fp_border(color="gray40") ) %>% 
  vline(part = "all", j = c(3,6),  border = officer::fp_border(color="gray80") )
  
 
tab_sftyAll_det_lowERC 

# ![](C:/Git/Proj_CAPlans/model_CalPERS/analysis/PlanInfo.png)
# ![](https://app.lucidchart.com/publicSegments/view/be8af79b-9988-4194-9744-da60cb0a45d5/image.png)
```


```{r eval=FALSE, include=FALSE}

# Average age of active members and reirees 

ls_miscAll <- readRDS(paste0(here::here(), "/model/tiers/tierData/tierData_miscAll.rds"))
ls_sftyAll <- readRDS(paste0(here::here(), "/model/tiers/tierData/tierData_sftyAll.rds"))

# active members
ls_miscAll$df_n_actives %>% 
  summarise(age_avg = weighted.mean(age, nactives))

ls_sftyAll$df_n_actives %>% 
  summarise(age_avg = weighted.mean(age, nactives))



ls_miscAll$df_n_actives %>% 
  group_by(age) %>% 
  summarise(nactives = sum(nactives))

ls_sftyAll$df_n_actives %>% 
  group_by(age) %>% 
  summarise(nactives = sum(nactives)) 

# retirees(beneficiaries included)

ls_miscAll$df_n_servRet %>% 
  summarise(age_avg = weighted.mean(age, n_servRet))

ls_sftyAll$df_n_servRet %>% 
  summarise(age_avg = weighted.mean(age, n_servRet))


ls_miscAll$df_n_disbRet %>% 
  summarise(age_avg = weighted.mean(age, n_disbRet))

ls_sftyAll$df_n_disbRet %>% 
  summarise(age_avg = weighted.mean(age, n_disbRet))




```



```{r}

# Examples of illustrative individuals 

## Individuals
# 1. POFF member aged 45, (expect or retire at age 55)
# 2. POFF member member aged 65, (expect to live up to age 85(check))
# (POFF members have constant 3% benefit factor: 3%@50 rule. This rule
#  is used by the model, so no modificiation is needed)

# 3. Misc member aged 45, (expect or retire at age 55); initial benefit $75,000
# 4. Misc member aged 65, (expect to live up to age 85(check)); benefit at 65 $35,000 
# (2%@55 rule for misc members. This rule is used by the model, so no
#  modification is needed.)

## Measures to look at:
# 1. Benefit upon retirement (55?)
# 2. Benefit 20 years after retirement
# 3. pv of benefits upon retirement

# Calculate above for each policy

dir_outputs_val <- "model/valuation2/outputs_val/"
dir_outputs_sim <- "model/simulation/outputs_sim2t/"


get_examples <- function(simName,
                         valName_baseline,
                         fn_ea  = 25,
                         fn_age1 = 35,
                         fn_age2 = 45,
                         fn_age3 = 55,
                         fn_age4 = 65,
                         ben_init1 = 140000,
                         ben_init2 = 140000,
                         ben_init3 = 90000,
                         ben_init4 = 90000,
                         fn_ageRet = 55,
                         dr = 0.07){

# #   
# simName <- "sfty2t_benCut1_lowERC"
# valName_baseline <-  "sfty2t_bf100_cola2"
# # 
# # simName = "sfty2t_benCut1_lowERC"
# # simName = "sfty2t_benCut1_collowERC"
# # valName_baseline = "sfty2t_bf100_cola2"
# 
# 
# 
# fn_ea  = 25
# fn_age1 = 35
# fn_age2 = 45
# fn_age3 = 55
# fn_age4 = 65
# fn_ageRet = 55
# dr = 0.07
# 
# ben_init1 <- 140000
# ben_init2 <- 140000
# ben_init3 <- 60000
# ben_init4 <- 60000



ls_sim <- readRDS(paste0(dir_outputs_sim, paste0("sim_", simName,   ".rds")))
valName <- ls_sim$sim_paramlist$val_name

df_val_baseline <- readRDS(paste0(dir_outputs_val, paste0("val_", valName_baseline, ".rds")))
df_val_reduced  <- readRDS(paste0(dir_outputs_val, paste0("val_", valName,".rds")))


df_cola <- 
  ls_sim$results %>% 
  filter(sim %in% c(0, -2)) %>% 
  select(sim_name, sim, year, cola_actual) %>%
  mutate(sim = ifelse(sim == 0, "cola_a", "cola_s")) %>% 
  spread(sim, cola_actual)

tier_select <- paste0(str_extract(simName, "sfty|misc"), "_classic")


df_B <- 
left_join(
  df_val_baseline$indivLiab[[tier_select]]$servRet.la %>% 
    filter( (start_year == 2018 - (fn_age1 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            (start_year == 2018 - (fn_age2 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            (year_servRet == 2018 & age_servRet == fn_age3)| # retiree
            (year_servRet == 2018 & age_servRet == fn_age4) # retiree
           ) %>% 
     select(age_servRet, start_year, ea, age, year, B_baseline = B.servRet.la),
  
  df_val_reduced$indivLiab[[tier_select]]$servRet.la %>% 
    filter( (start_year == 2018 - (fn_age1 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            (start_year == 2018 - (fn_age2 - fn_ea) & ea == fn_ea & age_servRet ==  fn_ageRet)|
            (year_servRet == 2018 & age_servRet == fn_age3)| # retiree
            (year_servRet == 2018 & age_servRet == fn_age4) # retiree
           ) %>% 
    select(age_servRet, start_year, ea, age, year, B_reduced = B.servRet.la) 
) %>% 
# mutate(B_pctChg = B_reduced / B_baseline - 1) %>% 
arrange(start_year) %>% 
mutate(age_2018 = ea + 2018 - start_year) %>% 
left_join(df_cola, by = "year")

df_B %>% filter(age_2018<55)
df_B %>% filter(age_2018>=55, year == 2018)



df_wage_fct <- 
  df_B %>% 
  group_by(age_2018) %>% 
  filter(age_2018 <55, age == fn_ageRet) %>% 
  mutate(wage_fct =  case_when(age_2018 == fn_age1 ~ ben_init1,
                                              age_2018 == fn_age2 ~ ben_init2,
                                              age_2018 == fn_age3 ~ ben_init3,
                                              age_2018 == fn_age4 ~ ben_init4,
                                              TRUE ~ 0)  / B_baseline[1]) %>% 
  select(age_2018, wage_fct)


df_B %<>% 
  group_by(start_year, age_servRet, ea) %>% 
  # mutate(B_baseline0 = B_baseline,
  #        B_baseline = B_baseline * ifelse(age_2018 == fn_age1, ben_init1, ben_init3) / B_baseline0[1],
  #        B_reduced  = B_reduced  * ifelse(age_2018 == fn_age1, ben_init1, ben_init3) / B_baseline0[1],
  #        B_baseline0 = NULL
  #        )
   mutate(B_baseline0 = B_baseline,
          B_baseline = B_baseline * case_when(age_2018 == fn_age1 ~ ben_init1,
                                              age_2018 == fn_age2 ~ ben_init2,
                                              age_2018 == fn_age3 ~ ben_init3,
                                              age_2018 == fn_age4 ~ ben_init4,
                                              TRUE ~ 0) / B_baseline0[1],
          B_reduced  = B_reduced  * case_when(age_2018 == fn_age1 ~ ben_init1,
                                              age_2018 == fn_age2 ~ ben_init2,
                                              age_2018 == fn_age3 ~ ben_init3,
                                              age_2018 == fn_age4 ~ ben_init4,
                                              TRUE ~ 0)  / B_baseline0[1],
          B_baseline0 = NULL
         )

df_B %<>% 
  group_by(start_year, age_servRet, ea) %>% 
  mutate(B_a = B_reduced[age == min(age)] * lag(cumprod(1 + cola_a), default = 1),
         B_s = B_reduced[age == min(age)] * lag(cumprod(1 + cola_s), default = 1))


df_wage <- 
df_val_baseline$indivLiab[[tier_select]]$active %>% 
    mutate(start_year = year - (age - ea),
           age_2018 = ea + 2018 - start_year) %>% 
    filter((start_year == 2018 - (fn_age1 - fn_ea) & ea == fn_ea) |
           (start_year == 2018 - (fn_age2 - fn_ea) & ea == fn_ea)
           ) %>% 
    select(age_2018, age, sx, Bx.servRet.laca) %>% 
    group_by(age_2018) %>% 
    filter(age == min(age)) %>% 
    left_join(df_wage_fct) %>% 
    mutate(wage_adj = sx * wage_fct)



# df_B %<>% split(df_B$start_year)
# 
# for(i in names(df_B)){
#   #i <- "2003" 
#   
#   df_B[[i]] %<>% 
#     mutate(B_a = ifelse(year == min(year), B_reduced, 0),
#            B_s = ifelse(year == min(year), B_reduced, 0))
#   
#   for(j in df_B[[i]]$year[-1]){
#   #j = 2034
#       df_B[[i]]$B_a[df_B[[i]]$year == j] <- df_B[[i]]$B_a[df_B[[i]]$year == j - 1] * (1 + df_B[[i]]$cola_a[df_B[[i]]$year == j - 1])
#       df_B[[i]]$B_s[df_B[[i]]$year == j] <- df_B[[i]]$B_s[df_B[[i]]$year == j - 1] * (1 + df_B[[i]]$cola_s[df_B[[i]]$year == j - 1])
#   }  
# } 
  
df_B %<>% 
  mutate(B_a_pctChg = B_a / B_baseline - 1,
         B_s_pctChg = B_s / B_baseline - 1) %>%
  relocate(sim_name, age_2018) 
 

df_summary <- 
  df_B %>% 
  filter(age <= 85) %>% 
  group_by(age_2018) %>% 
  summarise(pvB_baseline    = sum(B_baseline    / (1 + dr)^(age - min(age))),
            pvB_a = sum(B_a / (1 + dr)^(age - min(age)) ),
            pvB_s = sum(B_s / (1 + dr)^(age - min(age))),
            B_baseline_init = B_baseline[age == min(age)],
            B_a_init = B_a[age == min(age)],
            B_s_init = B_s[age == min(age)],  
            B_baseline_age80  = B_baseline[age == 80],
            B_a_age80  = B_a[age == 80],
            B_s_age80  = B_s[age == 80]                  
            ) %>% 
  mutate(pvB_a_pctChg = pvB_a / pvB_baseline - 1,
         pvB_s_pctChg = pvB_s / pvB_baseline - 1,
         B_init_a_pctChg = B_a_init / B_baseline_init - 1,
         B_init_s_pctChg = B_s_init / B_baseline_init - 1,
         B_age80_a_pctChg = B_a_age80 / B_baseline_age80 - 1,
         B_age80_s_pctChg = B_s_age80 / B_baseline_age80 - 1,
         sim_name = simName,
         age_2018 = paste0("age", age_2018)
         ) %>% 
  relocate(sim_name)
df_summary

# inversing the table
# df_pvB2 <- 
#   df_pvB %>% 
#   select(sim_name, age_2018, pvB_a_pctChg, pvB_s_pctChg) %>% 
#   gather(Var, value, -sim_name, -age_2018) %>% 
#   spread(age_2018, value)

df_summary2 <- 
df_summary %>%  
  select(!contains("_s_")) %>% 
  select(sim_name, age_2018, B_b_init = B_baseline_init, B_a_init, B_b_age80 = B_baseline_age80, B_a_age80) #pvB_baseline, pvB_a)
df_summary2


df_summary3 <- 
bind_rows(
df_summary2 %>%    
  select(sim_name, age_2018, contains("_b_")) %>% 
  rename(B_zage80 = B_b_age80,
        B_init   = B_b_init) %>%  
  gather(variable, value, -sim_name, -age_2018) %>% 
  mutate(variable = paste0(age_2018,".",variable),
         age_2018 = NULL) %>%
  arrange(variable) %>% 
  spread(variable, value) %>% 
  mutate(type = "baseline") %>% 
  relocate(sim_name, type),

df_summary2 %>% 
  select(sim_name, age_2018, contains("_a_")) %>% 
  rename(B_zage80 = B_a_age80,
         B_init   = B_a_init) %>% 
  gather(variable, value, -sim_name, -age_2018) %>% 
  mutate(variable = paste0(age_2018,".",variable),
         age_2018 = NULL) %>%
  arrange(variable) %>% 
  spread(variable, value) %>% 
  mutate(type = "reform") %>% 
  relocate(sim_name, type)
)



df <- list(df_B = df_B,
           df_wage = df_wage,
           df_summary  = df_summary,
           df_summary2 = df_summary2,
           df_summary3 = df_summary3)
}


# ls_eg_misc_benCut1          <- get_examples(simName = "misc2t_benCut1_lowERC", valName_baseline = "misc2t_bf100_cola2")
# ls_eg_misc_colaCut1         <- get_examples(simName = "misc2t_colaCut1_lowERC", valName_baseline = "misc2t_bf100_cola2")
# ls_eg_misc_benCut1_colaCut1 <- get_examples(simName = "misc2t_benCut1_colaCut1_lowERC", valName_baseline  = "misc2t_bf100_cola2")
# ls_eg_misc_benCut2          <- get_examples(simName = "misc2t_benCut2_lowERC", valName_baseline = "misc2t_bf100_cola2")
# ls_eg_misc_colaCut2         <- get_examples(simName = "misc2t_colaCut2_lowERC", valName_baseline = "misc2t_bf100_cola2")
# ls_eg_misc_benCut2_colaCut2 <- get_examples(simName = "misc2t_benCut2_colaCut2_lowERC", valName_baseline  = "misc2t_bf100_cola2")

ls_eg_sfty_benCut1          <- get_examples(simName = "sfty2t_benCut1_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_eg_sfty_colaCut1         <- get_examples(simName = "sfty2t_colaCut1_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_eg_sfty_benCut1_colaCut1 <- get_examples(simName = "sfty2t_benCut1_colaCut1_lowERC", valName_baseline  = "sfty2t_bf100_cola2")
ls_eg_sfty_benCut2          <- get_examples(simName = "sfty2t_benCut2_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_eg_sfty_colaCut2         <- get_examples(simName = "sfty2t_colaCut2_lowERC", valName_baseline = "sfty2t_bf100_cola2")
ls_eg_sfty_benCut2_colaCut2 <- get_examples(simName = "sfty2t_benCut2_colaCut2_lowERC", valName_baseline  = "sfty2t_bf100_cola2")


#ls_eg_misc_benCut1$df_wage 
ls_eg_sfty_benCut1$df_wage 

#ls_eg_misc_benCut1$df_summary3 %>% kable() 
ls_eg_sfty_benCut1$df_summary3 %>% kable() 

#ls_eg_misc_colaCut1$df_summary3 %>% kable() 
ls_eg_sfty_colaCut1$df_summary3 %>% kable() 


#ls_eg_misc_benCut1_colaCut1$df_summary3 %>% kable() 
ls_eg_sfty_benCut1_colaCut1$df_summary3 %>% kable() 


#ls_eg_misc_colaCut1$df_summary3 %>% kable() 
ls_eg_misc_benCut1_colaCut1$df_summary3 %>% kable() 

# check adjusted salary
ls_eg_sfty_benCut1$df_wage %>% 
  select(age_2018, wage_adj, wage_unadj = sx)




df_tbl_eg1 <- 
  bind_rows(
    ls_eg_sfty_benCut1$df_summary3,
    ls_eg_sfty_colaCut1$df_summary3,
    ls_eg_sfty_benCut1_colaCut1$df_summary3,
    ls_eg_sfty_benCut2$df_summary3,
    ls_eg_sfty_colaCut2$df_summary3,
    ls_eg_sfty_benCut2_colaCut2$df_summary3
  ) %>%
  filter(type == "reform")


df_tbl_eg1  <- bind_rows(ls_eg_sfty_benCut1$df_summary3 %>%
                           filter(type == "baseline"),
                         df_tbl_eg1 ) %>% 
  select(-age55.B_init,-age65.B_init)
df_tbl_eg1


xlsx::write.xlsx2(df_tbl_eg1, paste0(here::here(), "/analysis/outputs_analysis/tbl_examples1.xlsx"))



df_tbl_eg1 %>% 
  select(!contains("age35."), -type)
  







## detective work
{
df1 <-
  df_results %>%
  filter(sim_name %in% c(
                         "misc2t_colaCut1_lowERC",
                         "misc2t_benCut1_colaCut1_lowERC",
                         "sfty2t_colaCut1_lowERC",
                         "sfty2t_benCut1_colaCut1_lowERC",
                         "poff2t_colaCut1_lowERC",
                         "poff2t_benCut1_colaCut1_lowERC"),
         sim == 0,
         year <= 2043
  ) %>%
  select(sim_name,year, cola_actual)

df1 %>%
  spread(sim_name, cola_actual)
#   
# 
# df1 <- 
#   df_results %>% 
#   filter(sim_name %in% c("misc2t_colaCut1_lowERC", 
#                          "misc2t_benCut1_colaCut1_lowERC",
#                          "sfty2t_colaCut1_lowERC", 
#                          "sfty2t_benCut1_colaCut1_lowERC"),
#          sim == 0,
#          year <= 2043
#   ) %>% 
#   select(sim_name,year, FR_MA) 
# 
# df1 %>% 
#   spread(sim_name, FR_MA)
#   
# 
# 
#  df_results %>% 
#   filter(sim_name %in% c("sfty2t_colaCut1_lowERC", 
#                          "sfty2t_benCut1_colaCut1_lowERC"),
#          sim == 0,
#          year <= 2050
#   ) %>% 
#   select(sim_name,year, var = cola_actual) %>% 
#   spread(sim_name, var) %>% 
#   as_tibble()
}

```




```{r}

df <- readRDS(paste0(here::here(),"/model/valuation2/outputs_val/val_poff2t_bf100_cola2.rds"))

df$aggLiab$sumTiers$active

# 
# df <- readRDS(paste0(here::here(),"/model/valuation2/outputs_val/val_misc2t_bf100_cola2.rds"))
# 
# df$aggLiab$sumTiers$active


```




